<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ToGetHer</title>
    <style>
        body {
            display: grid;
            place-items: center;
            background-color: black;
            margin-top: 100px;
        }
        .signup-body{
            background-color: gray;
            width: 900px;
            height: 600px;
        }
        .signup-div{
            margin-top: 100px;
            display: grid;
            grid-template-rows: 100px auto;
            grid-gap: 10px;
            place-items: center;
        }
        input{
            margin: 10px;
            width: 200px;
            height: 30px;
        }
        th{
            position: relative;
            padding: 0;
        }
        .submit-button{
            background-color: black;
            height: 215px;
            width: 100px;
            padding: 10px;
            box-sizing: border-box;
            color: white;
        }
        .email-button{
            background-color: black;
            padding: 10px;
            box-sizing: border-box;
            color: white;
        }
        .nickname-button{
            background-color: black;
            padding: 10px;
            box-sizing: border-box;
            color: white;
        }
    </style>
</head>
<body>
<div class="signup-body">
    <div class="signup-div">
    <h1>Sign Up</h1>
    <form action="/signup-callback" method="post" onsubmit="return checkAllInputValue()">
        <table>
            <tr>
                <th><input id="Email" placeholder="Email" name="Email" onfocusout="validateEmail()" required ></th>
                <th><button id="email-button" class="email-button" onclick="checkEmail()">Check Duplicate</button></th>
                <th rowspan="4"><button id="submit-button" class="submit-button" type="submit" onsubmit="submitSelectedInputs()">SignUp</button></th>
            </tr>
            <tr>
                <th><input id="Nickname" placeholder="NickName" name="Nickname" onfocusout="validateNickname()" required></th>
                <th><button class="nickname-button" onclick="checkNickname()">Check Duplicate</button></th>
            </tr>
            <tr>
                <th><input id="Password" placeholder="Password" name="Password" type="password" onkeyup="checkCurrentPasswordMatch()"  onfocusout="validatePassword()"  required></th>
                <th rowspan="2"><div id="current-password-match"></div></th>
            </tr>
            <tr>
                <th><input id="R-Password" placeholder="Reconfirm Password" type="password" onkeyup="checkCurrentPasswordMatch()" required></th>
            </tr>
        </table>
    </form>
    </div>
</div>
<script>
    let check = false;
    function submitSelectedInputs() {
        const form = document.getElementById("myForm");
        const selectedInputs = ['Email', 'Password', 'Nickname']; // 선택한 input 요소들의 id 속성 값 배열

        let formData = new FormData(); // FormData 객체 생성

        for (let i = 0; i < selectedInputs.length; i++) {
            const inputId = selectedInputs[i];
            const inputElement = form.querySelector('#' + inputId);

            if (inputElement) {
                formData.append(inputId, inputElement.value); // 선택한 input 요소들을 폼 데이터에 추가
            }
        }

        // 폼 데이터 전송 또는 처리
        // 예시: AJAX 요청을 사용하여 서버로 폼 데이터 전송
        const xhr = new XMLHttpRequest();
        xhr.open("POST", form.action, true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    // 요청 성공
                    console.log(xhr.responseText);
                } else {
                    // 요청 실패
                    console.error("Error: " + xhr.status);
                }
            }
        };
        xhr.send(formData);
    }
    function checkAllInputValue(){
        let EmailValid = validateEmail();
        let PasswordValid = validatePassword();
        let NicknameValid = validateNickname();
        let Email = document.getElementById("Email");
        let Nickname = document.getElementById("Nickname");

        check = Email.disable === true && Nickname.disable === true;

        if(EmailValid && PasswordValid && NicknameValid && check){
            return true;
        }
        alert("모든 입력을 다시 확인해 주세요")
        return false;
    }
    function checkEmail() {
        const Email = document.getElementById("Email");

        let xhr = new XMLHttpRequest();
        xhr.open("GET", "/email/duplicate-check?email=" + Email.value, true);
        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    alert("Email is unique");
                    Email.disabled = true;
                    check = true;
                } else {
                    alert("Email is already taken");
                    Email.disabled = false;
                    check = false;
                }
            }
        };
        xhr.send();
        event.preventDefault();
    }
    function validateEmail() {
        const emailInput = document.getElementById("Email");

        let email = emailInput.value;
        if (!email.includes("@")) {
            alert("이메일 형식이 맞지 않습니다.")
            return false;
        }
        return true;
    }

    function checkNickname() {
        const Nickname = document.getElementById("Nickname");

        let xhr = new XMLHttpRequest();
        xhr.open("GET", "/nickname/duplicate-check?nickname=" + Nickname.value, true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    alert("Nickname is unique");
                    Nickname.disabled = true;
                    check = true;
                } else {
                    alert("Nickname is already taken");
                    Nickname.disabled = false;
                    check = false;
                }
            }
        };
        xhr.send();
        event.preventDefault();
    }
    function validateNickname() {
        // 닉네임 유효성 검사 로직을 구현하세요.
        // 닉네임은 특수문자를 포함하지 않은 2~10자리여야 합니다.
        const regex = /^[가-힣a-zA-Z0-9]{2,10}$/;

        const nicknameInput = document.getElementById("Nickname");
        const NicknameSpan = document.getElementById("nicknameSpan");

        let nickname = nicknameInput.value;
        // 닉네임 유효성 검사
        if (!regex.test(nickname)) {
            alert("닉네임은 특수문자를 포함하지 않은 2~10자리여야 합니다.")
            return false;
        }
        NicknameSpan.style.color = "green";
        NicknameSpan.innerText = "Nickname is valid";

        return true;
    }

    function checkCurrentPasswordMatch(){
        let pw = document.getElementById("Password");
        let modal_pass = document.getElementById("R-Password");
        let message = document.getElementById("current-password-match");

        if(pw.value === modal_pass.value){
            message.style.color = "green";
            message.innerHTML = "Match!";
        }
        else {
            message.style.color = "red";
            message.innerHTML = "Not Match!";
        }
    }
    function validatePassword() {
        // 비밀번호 유효성 검사 로직을 구현하세요.
        // 비밀번호는 8~16자리수여야 합니다. 영문 대소문자, 숫자, 특수문자를 1개 이상 포함해야 합니다.
        const regex = /^(?=.*[A-Za-z])(?=.*\\d)(?=.*[$@$!%*#?&])[A-Za-z\\d$@$!%*#?&]{8,16}$/;

        // 비밀번호 유효성 검사
        const passwordInput = document.getElementById("Password");

        let password = passwordInput.value;
        if (regex.test(password)) {
            alert("비밀번호는 8~16자리수여야 합니다. 영문 대소문자, 숫자, 특수문자를 1개 이상 포함해야 합니다.")
            return false;
        }
        return true;
    }



</script>
</body>
</html>